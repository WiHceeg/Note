---
title: 2021-08-03-Colmap课程学习笔记
description: 彻底搞透视觉三维重建：原理剖析、代码讲解、及优化改进
#date: 2018-11-22 
#updated: 2020-07-25
categories:
- 3D视觉
tags:
- Colmap 
---



# 公开课：SFM原理与实践

内容：

1、What is Structure-from-Motion? 

传统必须知道相机位置

2、Difference between SFM and SLAM  

SFM 无序，离线，精度更高。SLAM 在线更关注定位

3、SFM algorithm introduction

Global、Incremental、Hybrid、Distributed

 06:07 4个开源。有个论文组合了框架。

Colmap 贴图慢

09:12 Global Sfm 

Rotation averaging，这里讲了它的难度，退化

12:31 讲了openmvg 的三次 BA

14:20 解决退化问题，标定等方法，Gloable图像覆盖很好的时候表现很好

16:14 Incremental 进来一张做一次 BA

17:28 增量式的方程。

增量式的问题，计算时间，这里讲了时间复杂度

有篇论文，对比 Ceres，GTSAM，g2o。误差累计的问题

4、SFM C++ demo(OpenCV +gtsam)

21:19 demo, opencv + gtsam 

24:05 代码 github

 5、SFM application future and improvements

应用和改进

高精度地图，古建筑

图像拼接

16:14 改进，

前端：1. 深度学习描述子。2. SiftGPU太老了，可以用**Popsift**

28:37 Global SfM 改进，深度图做相似变换更新本质矩阵

29:40 Incremental SfM 改进，大场景 DAGSfM，2. 替换 Ceres 3. 融合GPS、imu。后面还讲了很多

# colmap入门准备及基础知识

关心的问题

04:50 课程目录

colmap

07:00 用自己的描述子

07:40 基本矩阵8点，本质矩阵5点，本质矩阵恢复 R T，单应DLT

08:54 03年，P3P，09年 EPnP，**选最佳视角，选最佳视图，3 种方法，最好的是点位均匀**

10:30 colmap 对三角化做的改进，三点。1.选视角 2和3. local ransac 

11:30 BA改进，，3核函数，4过滤，5. 6.ba之前三角化 7.迭代次数 8. 冗余图像最小化，global BA分组

15:50 实战，无人机和车载

18:15 MVS，colmap+openmvs

课程特点

colmap 代码部分



22:45 三维重建 4 个部分

slam 和 三维重建的区别，上节课讲的又讲了一遍

25:40 应用场景

27:35 开源和闭源框架，4种（都是结合），讲了一些细节

31:30 5 ODM用于无人机，6 alicevision or meshroom

33:02 开源框架的组合，pipline 一共 6 种

35:21 商业软件，4 个，ContextCapture，PhotoScan，RealityCapture

37:46 为什么选择 colmap，

39:36 对比

41:53 特征点个数对比，openmvg_colmap 对比

45:36 colmap 编译，推荐安装顺序，降低ceres版本。windows 10 下方法

52:30 docker，这里有步骤，

54:00 colmap 图像坐标系，偏移了 0.5 像素。相机，世界。colmap 的pose 是 world to camera ，slam 是 sensor to world。

56:45 相对坐标和绝对坐标。空间坐标系5种 WGS84，UTM，转换。还有个作者的github链接

1:02:26 colmap主要相机模型，一共 7 种。然后讲了 4 个问题。3 默认固定主点坐标，4 simple Radial 相机模型并行BA

1:07:36 系数地图格式解析。与其他算法框架的相结合，如 Bundler、openmvs、mvs-texture

1:10:50 2. map-based 定位 3. 用关键帧post-bundle adjustment

1:16:13 photoscam 和 colmap 对比

# 1.colmap前端

## 第一章节 前端

> ### 1. feature extracting 模块
>
> (1)  sift 特征点检测流程
>
> (2)  sift 描述子生成流程
>
> (3)  **dsp-sift 算法**介绍
>
> ### 2. feature matching 模块
>
> (1)  匹配策略算法介绍
>
> a.   顺序匹配算法
>
> b.   空间匹配算法
>
> c.   暴力匹配算法
>
> d.   词汇树匹配算法
>
> e.   转移匹配算法
>
> (2)  几何验证技巧
>
> 
>
> 重点：
>
> 1、colmap 本身特征提取和匹配算法
>
> 2、自定义特征算子替换sift(非colamp 自带）



这节课讲特征提取与匹配

1:35 4部分

1:56 sift 高斯金字塔，4组金字塔，每一组金字塔图像个数等于 s + 3。曲面拟合

5:55 sift 特征描述，3 * 1.5σ半径，128维描述子

7:45 描述子归一化剔除

8:40 **dsp-sift** 12345，比superpoint好，而且更鲁棒

11:30 dsp-sift 的视图，空间域和尺度域，每个特征点大小不一样

13:14 colmap feature 存储格式，

15:46 colmap匹配算法，最常用顺序匹配，空间匹配（knn算法）。还有暴力，词汇树，

19:30 转移匹配，image pairs 匹配格式。colmap 默认用余弦相似度

21:11 几何验证，剔除 outliers ，标定相机利用 E/F, H/F, H/E 的内点个数比值来决定使用哪种模型来

23:13 非标定相机，用 F 矩阵，E矩阵没发得到

23:34 引导匹配-guide matching

24:36 邻接矩阵 adjacency matrix，无向图。红色代表匹配多，绿色代表匹配少

28:10 邻接矩阵的几何意义，匹配点的存储是记录特征点的索引对

31:23 剔除mask之外的特征，mask=rcnn剔除动态物体

35:24 自定义feature，例子，用 orb。存储格式，246，匹配点记录索引，colmap只支持128位。

42:00 track 构建，

48:52 解释 dsp-sift，对特征点用不同尺度进行计算，取平均值。比原本sift和superpoint好，有点类似深度学习池化层

# 公开课：SLAM\SfM中的两视图三角化算法

2019年的论文，IDWM，两视图三角化

1:28 三角化：两视图，根据匹配和pose恢复二维点的三维坐标

2:30 算法介绍，(1)线性最小二乘。(2)优化算法。(3)midpoint算法。

5:38 三种方法优缺点。**midpoint小视差大2d误差**，optimal小视差大3d误差

8:00 IDMM （还是**IDWM**）改进midpoint。u0, u1。to camera。

10:40 继续推公式。**加权平均**，深度越大，比重就小。

14:01 负深度，通常过滤。过滤准则

15:51 效果。

17:49 总结。小视差点通常过滤；远处点估计相机旋转有用...

20:25 python 实现

23:57 后面问答。

25:24 传统方法取1/2，IDWM加权平均

27:14 4-1，4-2 是讲加权平均的

# 2.1 后端 initialization 模块

1:09 先看 log 文件，第一步初始化两个图，然后三角化，BA。然后后方交汇，756/3580匹配点，PnP操作，Pose Refine，进行两次local BA，Retriangulation（减小drift对GBA的影响），全局BA。再进入一张图像，再进行 PnP，local BA，三角化，全局 BA....最后是所有的误差

6:52 目录。寻找初试像对，2D-2D

7:20 寻找初始像对。1. 手动选择。2. **自动**，匹配点书从大到小排序，第二张候选影像匹配数目大于 100

9:24 2.1 基本矩阵 F。1. CV解释，对极几何，公式推导；2摄影测量解释-共面条件方程。

13:10 F 矩阵自由度，7。1. CV 9未知数，尺度等价，dof-1，rank(F)=2, dof -1；2. 摄影测量 5 pose，2 intrinics。5 + 2 = 7。

14:44 求解 F，7点法，8点法。

15:31 8点法。**有代码**。最小二乘解，中心归一化，解线性方程，SVD。

17:34 7点法，lambda和mu，9个未知数，7个方程。有个**参考论文**标题。

19:13 7点法**代码**。一元三次方程。

22:31 本质矩阵，[t]xR = E，dof = 3+3-1=5。尺度等价性

24:30 colmap里本质矩阵解法。8点法，5点法。很多资料是线性解法，先算 F，再用内参解 E。5点法很复杂。

26:20 8点法

27:45 5点法，9未知数，dof为5，所以有4个基础解系。**步骤**：1. 提取4个特征向量。2. 加入约束方程。3. 高斯消元。4. 一元十次方程，求解E矩阵。

30:38 什么时候用 5 点，什么时候用 8 点。有**论文**。5点侧向运动好，8点车载好。非要说就是5点好

31:28 单应矩阵。colmap用DLT，平面约束，公式。

32:37 单应矩阵代码。难度是 5 点 和 7 点难。

34:03 本质矩阵恢复 R, T。公式，代码，判断，正景深约束

36:30 单应矩阵恢复 R, T。纯旋转，E = 0，Malis论文。公式

38:16 单应矩阵分解两种方法。1. 计算法向量法。2. 计算平移向量法。colmap用前者。这里讲了公式，有很多。

44:32 前两次作业。第二次: 金字塔个数对SfM精度的影响，有临界值。下节课讲 PnP

# 2.2 后端 resection 模块

我们更关注 SfM，MVS

1:48 6部分。1 **后方交会(PnP)**。2 选最佳视角。3 colmap P3P。4 colmap EPnP。5 Nakano P3P，19年论文，推导简单。6 总结。

3:23 后方交会。初始化后，三角化前。目的回复相机相对世界坐标系的位置。

4:00 colmap的改进，划分网格。选最佳视角：影响register，三角化

6:27 colmap选择视图的方法，3种方法 ：1点数；2比值；3colmap特色，根据分布得分。这里有代码和对比

7:22 **2003论文，P3P**，基于距离，余弦定理。

8:59 公式推导。

10:40 解一元四次方程，很复杂的公式。

11:05 这里是详细代码。

14:51 **EPnP，2009论文**。虚拟控制点，建立虚拟的世界坐标系，重心坐标系。这后面详细介绍了步骤

22:00 解 6 * 10 的方程。三组解，选重投影误差最小的。

23:30 Nakano P3P算法，借鉴 EPnP 算法思想。这里也有公式推导。

29:30 Nakano P3P总结。研究数值稳定性。

31:00 总结。1 高小山P3P比较老，可以换成其他P3P。2 hybird sfm case下，PnP问题就变成了P2P，6dof-> 3dof。3 **epnp的两个优势**。



# 2.3 后端三角化与bundle adjustment光束法平差模块

今天讲三角化和BA。鲁棒高效

先讲三角化。

1:45 目录，5 选权迭代多帧三角化，不是colmap里的

2:10 为什么要三角化。得到点的三维坐标。

3:12 三角化的条件，代码。正景深约束；角度约束，余弦定理。要满足这两个约束

5:10 两视图三角化，上次公开课讲了3种。colmap dlt法，摄影测量严密解法：通过共线条件方程

8:21 两视图三角化代码，套公式，svd

9:37 总结，两视图三角化3种方法（DLT，midpoint，optimal）对比。IDWM。

11:15 多帧三角化，影响三角化的因素。colamp用了loransac，L2范数最小。

14:30 讲了公式和代码

15:40 loransac里面做的优化，**这里要看下**。1 修改了ransac的random sampler 生成器 2 原本的ransac可能会多次采样相同的样本，colmap不会重复抽样。

18:48 IGG算法（选权迭代多帧三角化），**讲论文**。

25:35 复现代码

29:32 总结，IDWM替换DLT。



讲BA

34:40 怎样给colmap加入尺度。

35:27 目录，8部分。4 colmap 如何恢复尺度。5 gps约束。6 marker（gcp（控制点））约束。7 平面约束（比如激光雷达）8 固定位置只优化姿态

39:17 光束法平差的由来和历史，优化重投影误差。优化量：相机位姿（6自由度），structure（3d mark），时间复杂度（相机参数+3n+6N）^3。n是landmark，N是影像。

42:00 光束法平差的历史

44:23 BA算法的推导。**两种推导**。李群-利用矩阵；摄影测量-利用共线条件方程。

57:16 作者写的代码。ceres 只优化 RT，优化2d到3d。

58:23 colmap 中 BA的特色。

1. local ba 只优化 short-track landmark，**加快local ba速度**
2. 不是每次三角化后都进行gba，当模型增长到一定百分比才 gba，**分摊增量sfm的线性时间**
3. **柯西核函数**，抑制异常值
4. 每次BA结束，**filter** 重投影误差大的点和三角化角度小的点
5. 自标定的情况
6. **后三角化**，消除drift对gba的影响
7. ba迭代次数，**采用两次local ba**
8. 冗余视图最小化

1:03:00 恢复尺度，1双目相机替换单目系统。2测高数据，rgbd相机。3自然界物体的固定长度prior（**语义**）。4控制点或GPS

1:13:25 GPS约束的ba，跳过

1:17:10 GPS约束的ba，代码

1:22:00 marker（gcp）约束的ba

1:23:24 平面约束的BA算法原理

1:26:00 固定位置，只优化姿态的BA算法及代码。只优化旋转，6dof->3dof

1:29:00 作者开源的代码。从已知pose重建

# 3sfm实战

04:40 这节课讲一些个人经验

6:00 目录

7:00 实景三维中国建设技术大纲

9:10 正面例子：大势智慧公司。反面例子：有很多调用ContextCapture的SDK做成云平台。

13:00 三维重建从头到尾能掌握的，国内十个人。

13:30 SfM 在三维重建中的重要性。

16:00 **colmap使用**

:

:

:

:

:

:

:

:

:

:

:

:

:

:

:

:

:

:

:

:

:

:

:

::

::

::

::

::
